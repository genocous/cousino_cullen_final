import sqlite3
import nltk
from nltk.tokenize import word_tokenize
from nltk.corpus import stopwords
from collections import Counter
import plotly.express as px
import plotly.graph_objects as go
import pandas as pd

nltk.download('punkt')
nltk.download('stopwords')

conn = sqlite3.connect('tracks.db')
cursor = conn.cursor()

genre_keywords = ['pop', 'rap', 'hip hop', 'alt', 'country', 'indie']
genre_words = {keyword: [] for keyword in genre_keywords}

cursor.execute('SELECT id, name, genre FROM tracks')
data = cursor.fetchall()

for row in data:
    song_id, title, genre = row
    tokens = word_tokenize(title.lower())  

    stop_words = set(stopwords.words('english')) #removes words like 'the' 'a' 'in' etc.
    other_excluded = ['feat','taylor','version','lil','like','bon','iver','drake','travis','scott','thug','durk','juice']

    filtered_tokens = [word for word in tokens if word.isalpha() and word not in stop_words and word not in other_excluded and len(word) > 1]

    if genre:
      for keyword in genre_keywords:
          if keyword in genre.lower():
              genre_words[keyword].extend(filtered_tokens)

common_words = {}
for keyword, words in genre_words.items():
    common_words[keyword] = dict(Counter(words).most_common(10))  

with open("spotify_output.txt", "a") as f:

    for keyword, words_count in common_words.items():
        print(f"Most common words in {keyword.capitalize()} song titles:", file=f)
        for word, count in words_count.items():
            print(f"{word}: {count}", file=f)
        print("\n", file=f)

conn.close()

# Making visualization
data = []
for genre, subgenres in common_words.items():
    for subgenre, value in subgenres.items():
        data.append({'Genre': genre, 'Subgenre': subgenre, 'Value': value})

df = pd.DataFrame(data)
df['All Genres'] = 'All Genres'

fig = px.treemap(df, path=['All Genres', 'Genre', 'Subgenre'], values='Value',
                 color='Value',
                 hover_name='Subgenre',  
                 custom_data=['Value'],
                 color_continuous_scale='Greens',
                 range_color=[0,10])

fig.update_layout(
    title='Common Words in Music Titles by Genre',
    margin=dict(t=50, l=0, r=0, b=0),
    width=1200,
    height=600
)

fig.update_traces(
    hovertemplate='Label: %{label}<br>Value: %{customdata[0]}',
    textfont_size=18  
)

fig.show()
